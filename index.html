<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Run: Kabur dari Soal!</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #030712; /* Black/Ninja Color */
            --secondary-color: #1d4ed8; /* Blue-700 (Accent) */
            --success-color: #10b981; /* Emerald-500 */
            --danger-color: #ef4444; /* Red Block/Danger Color */
            --text-color: #1f2937;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #ffffff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 0;
            overflow: hidden; 
        }
        #game-container {
            width: 100%; 
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
        }
        #gameCanvas {
            border: 4px solid var(--primary-color);
            background-color: #ffffff;
            width: 100%;
            height: 400px; 
            border-radius: 16px;
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.694);
            touch-action: none; 
        }
        /* Custom progress bar for timer */
        #timerBar {
            height: 10px;
            background-color: var(--success-color);
            transition: width 0.1s linear;
        }
    </style>
</head>
<body class="bg-gray-200">

    <div id="game-container" class="bg-white shadow-2xl p-4 md:p-6 flex flex-col items-center">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800 mb-4 text-center">
            <span class="text-primary-color">Quiz Run:</span> Kabur dari Soal! ‚öîÔ∏è
        </h1>

        <!-- Canvas Game Area -->
        <canvas id="gameCanvas"></canvas>

        <!-- Score and Status Display -->
        <div id="ui-overlay" class="w-full mt-4 flex justify-between text-lg font-semibold text-gray-700 p-2 border-t border-gray-200">
            <div>Skor: <span id="scoreDisplay" class="text-secondary-color">0</span></div>
            <div>Balok ke: <span id="blocksCounterDisplay" class="text-danger-color">0/25</span></div>
            <div>High Score: <span id="highScoreDisplay" class="text-primary-color">0</span></div>
        </div>

        <!-- Instruksi Swipe Control -->
        <div class="text-sm text-gray-500 mt-2 font-medium">
            Geser (Swipe) Kiri/Kanan untuk bergerak!
        </div>


        <!-- Game/Quiz Modal (Digunakan untuk Menu, Game Over, dan Kuis) -->
        <div id="gameModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-50 flex justify-center items-center p-4">
            <div id="modalContent" class="bg-white p-8 rounded-xl shadow-2xl text-center max-w-sm w-full">
                <!-- Konten modal ditangani oleh JavaScript -->
            </div>
        </div>
    </div>

    <script type="module">
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const blocksCounterDisplay = document.getElementById('blocksCounterDisplay');
        const highScoreDisplay = document.getElementById('highScoreDisplay');
        const gameModal = document.getElementById('gameModal');
        const modalContent = document.getElementById('modalContent');
        
        // --- Gambar Karakter (Perubahan Penting) ---
        const playerImage = new Image();
        // Menggunakan placeholder gambar ninja dari i.imgur.com
        // Ukuran: 50x50, Warna Latar: Hitam (000), Teks: Putih (fff)
        playerImage.src = "https://zhalzhabilah261-star.github.io/nezzz/"; 
        
        let isImageLoaded = false;
        playerImage.onload = () => {
            isImageLoaded = true;
            // Setelah gambar dimuat, panggil resizeCanvas dan showMenu untuk memastikan gambar muncul
            resizeCanvas();
            if (gameState === 'MENU') {
                showMenu();
            }
        };
        // Fallback jika terjadi error
        playerImage.onerror = () => {
            console.error("Gagal memuat gambar karakter. Menggunakan emoji sebagai fallback.");
            player.useEmojiFallback = true;
            isImageLoaded = true;
            resizeCanvas();
            if (gameState === 'MENU') {
                showMenu();
            }
        }
        
        // --- Game Constants and State ---
        let gameState = 'MENU'; 
        let score = 0;
        let speed = 3; 
        let highScore = localStorage.getItem('quizRunHighScoreFraction') ? parseInt(localStorage.getItem('quizRunHighScoreFraction')) : 0;
        let blocksPassed = 0;
        const BLOCKS_PER_QUIZ = 25;
        const QUIZ_TIME_LIMIT = 45; 
        const QUIZ_POINTS = 25;
        const SURRENDER_DEDUCTION = 10;
        
        // Dynamic Lane variables
        let LANE_WIDTH;
        let LANES;
        let quizTimer;
        
        // Karakter Ninja
        const player = {
            lane: 1, 
            x: 0, 
            y: 0,
            width: 50, // Diperbarui sesuai ukuran gambar (50x50)
            height: 50, 
            color: 'var(--primary-color)', 
            targetX: 0,
            isMoving: false,
            useEmojiFallback: false // Penanda fallback
        };

        let obstacles = [];
        let lastObstacleSpawn = 0;
        const obstacleSpawnInterval = 600; 

        // --- Responsiveness and Setup ---
        
        /** Menyesuaikan ukuran kanvas agar responsif */
        function resizeCanvas() {
            const container = document.getElementById('game-container');
            canvas.width = container.offsetWidth - 32; 
            canvas.height = Math.min(window.innerHeight * 0.7, 500); 

            LANE_WIDTH = canvas.width / 3;
            LANES = [
                LANE_WIDTH / 2, 
                LANE_WIDTH + LANE_WIDTH / 2, 
                LANE_WIDTH * 2 + LANE_WIDTH / 2 
            ];
            
            // Update posisi pemain berdasarkan lane baru
            player.targetX = LANES[player.lane];
            // Player Y disesuaikan dengan tinggi gambar
            player.y = canvas.height - player.height / 2; 
            
            if (gameState === 'MENU' || gameState === 'GAMEOVER') {
                drawRoad(); 
                drawPlayer();
            }
        }
        
        window.addEventListener('load', resizeCanvas);
        window.addEventListener('resize', resizeCanvas);


        // --- Utility Functions (Tetap) ---

        /** Mengacak elemen array */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /** Mengubah pecahan menjadi string format N/D atau bilangan bulat */
        function formatFraction(n, d) {
            if (n === 0) return "0";
            if (d === 0) return "Err";
            
            const g = gcd(Math.abs(n), d);
            const num = n / g;
            const den = d / g;

            if (den === 1) return String(num);
            return `${num}/${den}`;
        }

        /** Greatest Common Divisor (FPB) */
        function gcd(a, b) {
            return b ? gcd(b, a % b) : a;
        }

        /** Generator Soal Pecahan (Penjumlahan/Pengurangan) */
        function generateFractionQuiz() {
            const denominators = [4, 6, 8, 10];
            const den = denominators[Math.floor(Math.random() * denominators.length)];
            let num1 = Math.floor(Math.random() * (den - 1)) + 1; 
            let num2 = Math.floor(Math.random() * (den - 1)) + 1;
            
            const op = Math.random() < 0.5 ? '+' : '-';
            let correctNum;

            if (op === '+') {
                correctNum = num1 + num2;
            } else {
                if (num1 < num2) {
                    [num1, num2] = [num2, num1]; 
                }
                correctNum = num1 - num2;
            }

            const questionText = `${formatFraction(num1, den)} ${op} ${formatFraction(num2, den)} = ?`;
            const correctAnswer = formatFraction(correctNum, den);

            let wrongAnswers = [];
            wrongAnswers.push(formatFraction(correctNum + (Math.random() < 0.5 ? 1 : -1) * (Math.floor(Math.random() * 2) + 1), den));
            wrongAnswers.push(formatFraction(correctNum, den + (Math.random() < 0.5 ? 1 : -1) * 2));

            let options = new Set([correctAnswer]);
            while (options.size < 3) {
                const wa = wrongAnswers[Math.floor(Math.random() * wrongAnswers.length)];
                if (wa !== correctAnswer) {
                     options.add(wa);
                } else {
                    options.add(formatFraction(correctNum + (Math.random() < 0.5 ? 1 : -1), den + (Math.random() < 0.5 ? 1 : -1)));
                }
            }
            
            const finalOptions = shuffleArray(Array.from(options));
            const correctChoiceIndex = finalOptions.indexOf(correctAnswer);

            return {
                text: questionText,
                answers: finalOptions,
                correctIndex: correctChoiceIndex,
            };
        }

        // --- Drawing Functions (Perubahan Penting di Sini) ---

        /** Menggambar karakter Ninja (Gambar atau Emoji Fallback) */
        function drawPlayer() {
            // Animasi pergerakan halus
            if (player.x !== player.targetX) {
                const diff = player.targetX - player.x;
                player.x += diff * 0.15; 
                if (Math.abs(diff) < 1) {
                    player.x = player.targetX;
                    player.isMoving = false;
                }
            }
            
            const drawX = player.x - player.width / 2;
            const drawY = player.y - player.height / 2; // Pusat gambar di posisi Y pemain
            
            // Efek visual sukses
            if (player.color !== 'var(--primary-color)') {
                ctx.save();
                ctx.shadowColor = 'var(--success-color)';
                ctx.shadowBlur = 15;
            }

            if (isImageLoaded && !player.useEmojiFallback) {
                // Menggambar gambar
                ctx.drawImage(playerImage, drawX, drawY, player.width, player.height);
            } else {
                // Fallback ke Emoji jika gambar gagal dimuat
                const emoji = 'ü•∑üèª'; 
                const fontSize = player.height * 1.5; 
                ctx.font = `900 ${fontSize}px Inter, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'bottom';
                ctx.fillText(emoji, player.x, player.y + player.height / 2);
            }
            
            if (player.color !== 'var(--primary-color)') {
                ctx.restore();
            }
        }

        /** Menggambar jalan dan batas jalur */
        function drawRoad() {
            ctx.fillStyle = '#f3f4f6'; 
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.strokeStyle = '#d1d5db'; 
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 15]); 

            for(let i = 1; i < LANES.length; i++) {
                ctx.beginPath();
                ctx.moveTo(LANE_WIDTH * i, 0);
                ctx.lineTo(LANE_WIDTH * i, canvas.height);
                ctx.stroke();
            }
            
            ctx.setLineDash([]); 
        }

        /** Menggambar Obstacle Block (Merah) */
        function drawBlock(block) {
            const x = LANES[block.lane] - block.width / 2;
            const y = block.y;
            
            ctx.fillStyle = block.color; 
            
            // Gambar kotak yang jelas dengan shadow
            ctx.beginPath();
            ctx.rect(x, y, block.width, block.height);
            ctx.fillStyle = 'var(--danger-color)';
            ctx.shadowColor = 'rgba(255, 0, 0, 0.7)';
            ctx.shadowBlur = 10;
            ctx.fill();
            ctx.shadowBlur = 0; 
        }
        
        // --- Game Logic Functions ---

        /** Spawn Balok Penghalang */
        function spawnObstacle() {
            if (gameState !== 'PLAYING') return;

            const currentTime = Date.now();
            if (currentTime - lastObstacleSpawn < obstacleSpawnInterval / (speed / 3)) { 
                return;
            }
            lastObstacleSpawn = currentTime;
            
            // Spawn Regular Block (Merah)
            const lane = Math.floor(Math.random() * 3);
            const newBlock = {
                type: 'block',
                y: -50,
                width: 50,
                height: 50,
                lane: lane,
                color:'red'
            };
            obstacles.push(newBlock);
        }
        
        /** Update posisi objek dan cek tabrakan */
        function updateObstacles() {
            if (gameState !== 'PLAYING') return;
            
            // Definisi batas kotak tabrakan pemain
            const playerXLeft = player.x - player.width / 2;
            const playerXRight = player.x + player.width / 2;
            const playerYTop = player.y - player.height / 2; 
            const playerYBottom = player.y + player.height / 2;

            for (let i = obstacles.length - 1; i >= 0; i--) {
                let obj = obstacles[i];
                obj.y += speed;

                if (obj.type === 'block') {
                    // Definisi batas kotak tabrakan objek
                    const objXLeft = LANES[obj.lane] - obj.width / 2;
                    const objXRight = LANES[obj.lane] + obj.width / 2;
                    const objYTop = obj.y; 
                    const objYBottom = obj.y + obj.height;
                    
                    // Cek Tabrakan Blok
                    const isCollisionLane = obj.lane === player.lane;
                    // Tabrakan Y: ObjekYTop harus di bawah PlayerYBottom, DAN ObjekYBottom harus di atas PlayerYTop
                    const isCollisionY = objYTop < playerYBottom && objYBottom > playerYTop;
                    
                    if (isCollisionLane && isCollisionY) {
                        gameOver('Tertabrak Balok Merah!!!.');
                        return;
                    }

                    // Blok berhasil dilewati
                    if (obj.y > playerYBottom && !obj.passed) {
                        blocksPassed++;
                        score += 1;
                        obj.passed = true;
                        
                        // Cek peningkatan kecepatan (setiap 50 poin)
                        if (score % 50 === 0 && score > 0) {
                            speed = Math.min(speed + 0.5, 12); 
                        }
                    }
                }

                // Hapus objek yang sudah melewati layar
                if (obj.y > canvas.height) {
                    obstacles.splice(i, 1);
                }
            }
        }

        /** Pindah jalur pemain */
        function movePlayer(direction) {
            if (gameState !== 'PLAYING' || player.isMoving) return;

            const newLane = player.lane + direction;
            if (newLane >= 0 && newLane <= 2) {
                player.lane = newLane;
                player.targetX = LANES[newLane];
                player.isMoving = true;
            }
        }

        /** Loop utama game */
        function gameLoop() {
            if (gameState !== 'PLAYING') return;
            
            // 1. Cek Kuis
            if (blocksPassed >= BLOCKS_PER_QUIZ) {
                gameState = 'QUIZ_MODAL';
                showQuizModal();
                return; // Jeda permainan
            }

            // 2. Update Game State
            spawnObstacle();
            updateObstacles();
            
            // 3. Draw Game
            drawRoad();
            obstacles.forEach(obj => {
                if (obj.type === 'block') {
                    drawBlock(obj);
                }
            });
            drawPlayer();
            
            // 4. Update UI
            scoreDisplay.textContent = score;
            blocksCounterDisplay.textContent = `${blocksPassed}/${BLOCKS_PER_QUIZ}`;
            highScoreDisplay.textContent = highScore;
            
            requestAnimationFrame(gameLoop);
        }
        
        // --- Modal & Quiz Logic ---
        
        /** Menampilkan modal kuis dengan timer */
        function showQuizModal() {
            const quizData = generateFractionQuiz();
            let timeLeft = QUIZ_TIME_LIMIT;
            
            const renderModal = (time) => {
                const buttonClass = (index) => `w-full my-1 py-3 px-4 font-extrabold rounded-lg transition duration-200 shadow-md 
                    bg-secondary-color text-white hover:bg-blue-800`;

                modalContent.innerHTML = `
                    <h2 class="text-3xl font-extrabold text-secondary-color mb-3">TES KECEPATAN MATEMATIKA! üß†</h2>
                    <p class="text-xl font-bold text-gray-800 mb-4">Waktu Tersisa: <span id="timeRemaining">${time}</span>s</p>
                    <div id="timerContainer" class="w-full bg-gray-200 rounded-full mb-6">
                        <div id="timerBar" class="rounded-full" style="width: ${time / QUIZ_TIME_LIMIT * 100}%;"></div>
                    </div>
                    
                    <h3 class="text-3xl font-extrabold text-primary-color mb-6">${quizData.text}</h3>
                    
                    <div id="quizOptions" class="grid grid-cols-1 gap-2 mb-6">
                        ${quizData.answers.map((ans, index) => `
                            <button data-index="${index}" class="${buttonClass(index)} answer-btn">
                                ${['A', 'B', 'C'][index]}. ${ans}
                            </button>
                        `).join('')}
                    </div>

                    <p class="text-sm text-gray-500 mb-4">Jika salah atau waktu habis: Game Over. Jika menyerah, poin dikurangi.</p>
                    <button id="surrenderButton" class="bg-gray-400 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500 transition duration-200">
                        Menyerah (Potong ${SURRENDER_DEDUCTION} Poin)
                    </button>
                `;
            };

            const hideQuizModal = () => {
                clearInterval(quizTimer);
                gameModal.classList.add('hidden');
                gameState = 'PLAYING';
                blocksPassed = 0; // Reset counter balok
                requestAnimationFrame(gameLoop);
            };

            const handleAnswer = (selectedIndex) => {
                clearInterval(quizTimer);
                if (selectedIndex === quizData.correctIndex) {
                    score += QUIZ_POINTS;
                    player.color = 'var(--success-color)';
                    setTimeout(() => player.color = 'var(--primary-color)', 300);
                    hideQuizModal();
                } else {
                    gameOver(`Jawaban Salah! Jawaban benar adalah ${quizData.answers[quizData.correctIndex]}.`);
                }
            };
            
            const handleSurrender = () => {
                clearInterval(quizTimer);
                score = Math.max(0, score - SURRENDER_DEDUCTION);
                player.color = 'var(--danger-color)';
                setTimeout(() => player.color = 'var(--primary-color)', 300);
                hideQuizModal();
            };

            // Setup timer
            const intervalDuration = 100; 
            let startTime = Date.now();

            quizTimer = setInterval(() => {
                const timePassed = (Date.now() - startTime) / 1000;
                timeLeft = QUIZ_TIME_LIMIT - timePassed;

                if (timeLeft <= 0) {
                    clearInterval(quizTimer);
                    gameOver('Waktu Habis! Anda gagal menjawab kuis tepat waktu.');
                    return;
                }
                
                // Update timer UI (only full seconds)
                document.getElementById('timeRemaining').textContent = Math.ceil(timeLeft);
                
                // Update bar width
                const bar = document.getElementById('timerBar');
                const widthPercentage = (timeLeft / QUIZ_TIME_LIMIT) * 100;
                bar.style.width = `${widthPercentage}%`;

                // Change bar color near end
                if (widthPercentage < 20) {
                    bar.style.backgroundColor = 'var(--danger-color)';
                } else if (widthPercentage < 50) {
                    bar.style.backgroundColor = 'orange';
                } else {
                    bar.style.backgroundColor = 'var(--success-color)';
                }

            }, intervalDuration);

            renderModal(QUIZ_TIME_LIMIT);
            gameModal.classList.remove('hidden');

            // Attach listeners to newly created buttons
            document.querySelectorAll('.answer-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    handleAnswer(parseInt(e.target.dataset.index));
                });
            });
            
            document.getElementById('surrenderButton').addEventListener('click', handleSurrender);
        }

        /** Menghentikan game dan menampilkan modal Game Over */
        function gameOver(reason) {
            gameState = 'GAMEOVER';
            clearInterval(quizTimer); // Pastikan timer dihentikan
            
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('quizRunHighScoreFraction', highScore);
            }

            modalContent.innerHTML = `
                <h2 class="text-4xl font-extrabold text-danger-color mb-3"> YAHH GAME OVER! üò≠</h2>
                <p class="text-lg text-gray-700 mb-4">${reason}</p>
                <p class="text-xl font-bold mb-4">Skor Akhir: <span class="text-secondary-color">${score}</span></p>
                <p class="text-md font-semibold text-gray-600 mb-6">Skor Tertinggi: ${highScore}</p>
                <button id="retryButton" class="bg-primary-color text-red font-bold py-3 px-6 rounded-xl hover:bg-emerald-800 transition duration-200 shadow-lg">
                    Lari Lagi!
                </button>
            `;
            gameModal.classList.remove('hidden');

            document.getElementById('retryButton').onclick = startGame;
        }

        /** Memulai game */
        function startGame() {
            score = 0;
            speed = 3; 
            blocksPassed = 0;
            obstacles = [];
            player.lane = 1;
            player.targetX = LANES[1];
            player.x = LANES[1];
            player.color = 'var(--primary-color)';
            gameState = 'PLAYING';
            gameModal.classList.add('hidden');
            lastObstacleSpawn = Date.now();
            requestAnimationFrame(gameLoop);
        }

        // --- Touch Control Logic (Swipe) ---
        let touchStartX = 0;
        const SWIPE_THRESHOLD = 30; 

        canvas.addEventListener('touchstart', (e) => {
            if (gameState !== 'PLAYING') return;
            touchStartX = e.touches[0].clientX;
            e.preventDefault(); 
        }, false);

        canvas.addEventListener('touchend', (e) => {
            if (gameState !== 'PLAYING') return;
            const touchEndX = e.changedTouches[0].clientX;
            const deltaX = touchEndX - touchStartX;
            
            if (Math.abs(deltaX) > SWIPE_THRESHOLD) {
                if (deltaX > 0) {
                    movePlayer(1); // Swipe Right
                } else {
                    movePlayer(-1); // Swipe Left
                }
            }
            e.preventDefault();
        }, false);
        
        // --- Keyboard Listener (untuk desktop) ---
        document.addEventListener('keydown', (e) => {
            if (gameState === 'PLAYING') {
                if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
                    movePlayer(-1);
                } else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
                    movePlayer(1);
                }
            } else if (gameState === 'MENU' || gameState === 'GAMEOVER') {
                if (e.key === 'Enter') {
                    startGame();
                }
            }
        });


        // --- Inisialisasi Menu Awal ---
        
        function showMenu() {
            highScoreDisplay.textContent = highScore;
            modalContent.innerHTML = `
                <h2 class="text-3xl font-extrabold text-primary-color mb-3">Quiz Run: AYO KABUR DARI SOAL </h2>
                <p class="text-lg text-gray-700 mb-4 font-bold">Uji Kecepatan & Ketepatan Anda!</p>
                <div class="text-left mb-6 text-sm">
                    <p class="font-bold mb-2">Cara Bermain:</p>
                    <ul class="list-disc list-inside space-y-1 text-gray-600">
                        <li>Geser layar kiri/kanan untuk pindah jalur dan hindari Balok Merah.</li>
                        <li>Kecepatan permainan akan terus MENINGKAT seiring skor Anda (1 Poin / Balok).</li>
                        <li>Setelah 25 Balok, permainan berhenti untuk Kuis Pecahan.</li>
                        <li>Jawab dalam 45 detik untuk +${QUIZ_POINTS} Poin.</li>
                        <li>MENYERAH akan memotong ${SURRENDER_DEDUCTION} Poin.</li>
                    </ul>
                </div>
                <button id="startButton" class="bg-success-color text-black font-bold py-3 px-6 rounded-xl hover:bg-emerald-700 transition duration-200 shadow-lg">
                    Mulai Misi Ninja! (Tekan Enter)
                </button>
            `;
            gameModal.classList.remove('hidden');
            document.getElementById('startButton').onclick = startGame;
            // Pastikan gambar sudah dimuat sebelum ini
            if(isImageLoaded) {
                 resizeCanvas(); 
            }
        }

        window.onload = () => {
            // Jika gambar sudah dimuat sebelum onload selesai, panggil showMenu
            if(isImageLoaded) {
                showMenu();
            }
             // Jika belum dimuat, fungsi showMenu akan dipanggil di playerImage.onload
        };
        
    </script>
</body>
</html>